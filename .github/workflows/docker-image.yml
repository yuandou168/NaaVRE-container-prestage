name: Docker Image CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  
jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - id: files
      uses: jitterbit/get-changed-files@v1
    - run: |
        for changed_file in ${{ steps.files.outputs.all }}; do
          echo "Do something with this ${changed_file}."
          DIR="$(dirname "${changed_file}")"
          echo $DIR
          if [ "$DIR" != ".github/workflows" ]; then
            cd $DIR
            dockerfile=`ls Dockerfile.*`
            IFS='.' read -ra names_array <<< "$dockerfile"
            echo Building ${names_array[1]}/${names_array[2]}
            docker build . --file $dockerfile --tag ${names_array[1]}/${names_array[2]}
          fi
        done    
#     - uses: actions/checkout@v2        
#     - name: Build image
#       run:  |
#         ./build_all.sh build
      
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}


    - name: Push image to GitHub Container Registry
      run: |
        for changed_file in ${{ steps.files.outputs.all }}; do
          echo "Do something with this ${changed_file}."
          DIR="$(dirname "${VAR}")" ; FILE="$(basename "${VAR}")"
          if [ "$DIR" != ".github/workflows" ]; then
            cd $DIR
            dockerfile=`ls Dockerfile.*`
            IFS='.' read -ra names_array <<< "$dockerfile"
            echo push ${names_array[1]}/${names_array[2]}
            docker push ${names_array[1]}/${names_array[2]}
          fi
        done  
